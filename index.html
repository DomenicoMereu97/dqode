<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEQODE | Dynamic QR Redirector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        /* Google Font for Google Mode */
        .google-font {
            font-family: 'Roboto', arial, sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Android Keypad Effect */
        .keypad-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Custom Select Styles */
        select {
            color-scheme: dark;
        }

        select option {
            background-color: #1a1a1a;
            color: white;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion || { motion: (p) => <div {...p} />, AnimatePresence: (p) => p.children };

        // Icons Helper
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const parseIngestedContent = (content) => {
            const items = [];
            // 1. Python/Swift/JS Style Tuples/Arrays: ("Name", "https://...") or ["Name", "https://..."]
            const tupleRegex = /["']([^"']+)["']\s*,\s*["'](https?:\/\/[^"']+)["']/g;
            let match;
            while ((match = tupleRegex.exec(content)) !== null) {
                items.push({ id: 'i' + Math.random().toString(36).substr(2, 9), name: match[1], link: match[2] });
            }
            if (items.length > 0) return items;

            // 2. JSON-like objects: { "name": "...", "link": "..." }
            const objRegex = /["'](?:name|title|label)["']\s*:\s*["']([^"']+)["']\s*,\s*["'](?:link|url|href)["']\s*:\s*["'](https?:\/\/[^"']+)["']/g;
            while ((match = objRegex.exec(content)) !== null) {
                items.push({ id: 'i' + Math.random().toString(36).substr(2, 9), name: match[1], link: match[2] });
            }
            if (items.length > 0) return items;

            // 3. Markdown links: [Name](URL)
            const mdRegex = /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g;
            while ((match = mdRegex.exec(content)) !== null) {
                items.push({ id: 'i' + Math.random().toString(36).substr(2, 9), name: match[1], link: match[2] });
            }
            if (items.length > 0) return items;

            // 4. Simple Line Format: Name : URL or Name - URL or Name URL
            const lines = content.split('\n');
            lines.forEach(line => {
                const urlMatch = line.match(/(https?:\/\/[^\s]+)/);
                if (urlMatch) {
                    const link = urlMatch[1];
                    let name = line.replace(link, '').trim();
                    // Clean up common separators like :, -, numbers at start
                    name = name.replace(/^[\d\.\-\s\:\)\(]+|[\:\-\s\)\(]+$/g, '').trim();
                    if (!name) name = "Link " + (items.length + 1);
                    items.push({ id: 'i' + Math.random().toString(36).substr(2, 9), name, link });
                }
            });

            return items;
        };

        const STORAGE_KEY = 'deqode_state_v1';

        const defaultState = {
            lists: [
                {
                    id: 'l1',
                    name: 'Marketing',
                    items: [
                        { id: 'i1', name: 'Google', link: 'https://google.com' },
                        { id: 'i2', name: 'Apple', link: 'https://apple.com' },
                        { id: 'i3', name: 'Amazon', link: 'https://amazon.com' },
                    ]
                }
            ],
            activeListId: 'l1',
            activeItemId: 'i1',
            fakeSearch: {
                fakePhrase: 'Quante canzoni ci sono nel mondo?',
                targetService: 'youtube'
            },
            isStealth: false
        };

        const App = () => {
            const [view, setView] = useState('dashboard'); // dashboard, lock, qr, redirect
            const [state, setState] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : defaultState;
            });

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                // Sync across tabs
                const handleStorage = (e) => {
                    if (e.key === STORAGE_KEY) setState(JSON.parse(e.newValue));
                };
                window.addEventListener('storage', handleStorage);
                return () => window.removeEventListener('storage', handleStorage);
            }, [state]);

            // Sync with Server for Dynamic Redirect
            useEffect(() => {
                // IMPORTANT: If we are in stealth mode (Google Mode), don't let the dashboard sync 
                // overwrite the secret target until we manually leave that mode.
                if (state.isStealth) return;

                const list = state.lists.find(l => l.id === state.activeListId);
                const item = list?.items.find(i => i.id === state.activeItemId);
                if (item) {
                    fetch(`/api/set-target?url=${encodeURIComponent(item.link)}`)
                        .catch(err => console.log("Standalone mode or server unreachable"));
                }
            }, [state.activeListId, state.activeItemId, state.lists, state.isStealth]);

            // Invisible Instant Redirect (Fallback for static files)
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('r') === '1') {
                    const list = state.lists.find(l => l.id === state.activeListId);
                    const item = list?.items.find(i => i.id === state.activeItemId);
                    if (item) {
                        window.location.replace(item.link);
                    }
                }
            }, []);

            const updateState = (updates) => setState(prev => ({ ...prev, ...updates }));

            const activeLink = useMemo(() => {
                const list = state.lists.find(l => l.id === state.activeListId);
                const item = list?.items.find(i => i.id === state.activeItemId);
                return item?.link || 'https://google.com';
            }, [state]);

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                }
            };

            useEffect(() => {
                if (view === 'lock' || view === 'google') {
                    toggleFullscreen();
                }
            }, [view]);

            return (
                <div className="min-h-screen" onClick={view === 'lock' ? toggleFullscreen : undefined}>
                    <AnimatePresence mode="wait">
                        {view === 'dashboard' && <Dashboard key="dash" state={state} updateState={updateState} setView={setView} />}
                        {view === 'lock' && <LockScreen key="lock" state={state} updateState={updateState} setView={setView} />}
                        {view === 'qr' && <QRView key="qr" activeLink={activeLink} setView={setView} />}
                        {view === 'redirect' && <RedirectView key="red" activeLink={activeLink} />}
                        {view === 'google' && <GoogleMode key="google" settings={state.fakeSearch} setView={setView} updateTarget={(url) => fetch(`/api/set-target?url=${encodeURIComponent(url)}`)} />}
                    </AnimatePresence>
                </div>
            );
        };

        const Dashboard = ({ state, updateState, setView }) => {
            const [newListName, setNewListName] = useState('');
            const [showImport, setShowImport] = useState(false);
            const [importTargetListId, setImportTargetListId] = useState(null); // null means new list

            const addList = () => {
                if (!newListName) return;
                const newList = { id: 'l' + Date.now(), name: newListName, items: [] };
                updateState({ lists: [...state.lists, newList] });
                setNewListName('');
            };

            const deleteList = (id) => {
                updateState({ lists: state.lists.filter(l => l.id !== id) });
            };

            const addItem = (listId) => {
                const newItem = { id: 'i' + Date.now(), name: 'New Link', link: 'https://' };
                const newLists = state.lists.map(l => l.id === listId ? { ...l, items: [...l.items, newItem] } : l);
                updateState({ lists: newLists });
            };

            const updateItem = (listId, itemId, updates) => {
                const newLists = state.lists.map(l => l.id === listId ? { ...l, items: l.items.map(i => i.id === itemId ? { ...i, ...updates } : i) } : l);
                updateState({ lists: newLists });
            };

            const selectItem = (listId, itemId) => {
                updateState({ activeListId: listId, activeItemId: itemId });
            };

            const handleImport = (items) => {
                if (importTargetListId) {
                    // Append to existing list
                    const newLists = state.lists.map(l => l.id === importTargetListId ? { ...l, items: [...l.items, ...items] } : l);
                    updateState({ lists: newLists });
                } else {
                    // Create new list
                    const newList = { id: 'l' + Date.now(), name: 'Imported List', items };
                    updateState({ lists: [...state.lists, newList], activeListId: newList.id, activeItemId: items[0]?.id });
                }
                setShowImport(false);
                setImportTargetListId(null);
            };

            return (
                <div className="p-4 md:p-12 max-w-7xl mx-auto animate-fade-in w-full overflow-x-hidden">
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8 md:mb-12">
                        <div className="flex flex-col">
                            <h1 className="text-4xl md:text-5xl font-extrabold tracking-tighter bg-gradient-to-r from-blue-400 to-purple-600 bg-clip-text text-transparent">DEQODE</h1>
                            <p className="text-white/40 mt-2 font-medium text-xs md:text-sm">Dynamic QR Destination Manager</p>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 scroll-hide">
                            <button onClick={() => setView('qr')} className="glass flex-shrink-0 px-4 md:px-6 py-3 rounded-2xl flex items-center gap-2 hover:bg-white/10 transition-all font-semibold uppercase tracking-wider text-[10px] md:text-xs">
                                <Icon name="qr-code" size={16} /> View QR
                            </button>
                            <button onClick={() => { updateState({ isStealth: false }); setView('lock'); }} className="glass flex-shrink-0 px-4 md:px-6 py-3 rounded-2xl flex items-center gap-2 hover:bg-white/10 transition-all font-semibold uppercase tracking-wider text-[10px] md:text-xs bg-blue-600/20 border-blue-500/30">
                                <Icon name="smartphone" size={16} /> Lock
                            </button>
                            <button onClick={() => { updateState({ isStealth: true }); setView('google'); }} className="glass flex-shrink-0 px-4 md:px-6 py-3 rounded-2xl flex items-center gap-2 hover:bg-white/10 transition-all font-semibold uppercase tracking-wider text-[10px] md:text-xs bg-purple-600/20 border-purple-500/30">
                                <Icon name="search" size={16} /> Google
                            </button>
                        </div>
                    </header>

                    {/* Fake Search Config */}
                    <div className="glass p-5 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] mb-12 flex flex-col lg:flex-row gap-6 lg:gap-8 items-stretch lg:items-end border-purple-500/20">
                        <div className="flex-1 flex flex-col gap-3">
                            <label className="text-[10px] font-black uppercase tracking-[0.2em] text-purple-400">Stealth Configuration</label>
                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="flex-1">
                                    <span className="text-[10px] text-white/30 uppercase font-bold block mb-1">Display Phrase</span>
                                    <input
                                        className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm outline-none focus:border-purple-500 focus:bg-white/10 transition-all"
                                        value={state.fakeSearch?.fakePhrase || ''}
                                        onChange={e => updateState({ fakeSearch: { ...state.fakeSearch, fakePhrase: e.target.value } })}
                                    />
                                </div>
                                <div className="w-full md:w-64">
                                    <span className="text-[10px] text-white/30 uppercase font-bold block mb-1">Secret Target</span>
                                    <div className="relative">
                                        <select
                                            className="w-full bg-[#1a1a1a] border border-white/20 rounded-xl p-3 text-sm outline-none focus:border-purple-500 appearance-none pr-10 text-white"
                                            value={state.fakeSearch?.targetService || 'youtube'}
                                            onChange={e => updateState({ fakeSearch: { ...state.fakeSearch, targetService: e.target.value } })}
                                        >
                                            <option value="youtube">YouTube Results</option>
                                            <option value="google_images">Google Images</option>
                                            <option value="spotify">Spotify Search</option>
                                            <option value="google">Standard Google</option>
                                        </select>
                                        <Icon name="chevron-down" size={16} className="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onClick={() => { updateState({ isStealth: true }); setView('google'); }} className="bg-purple-600 px-8 py-4 rounded-2xl font-bold flex gap-2 items-center justify-center hover:bg-purple-500 transition-all shadow-lg shadow-purple-600/20 active:scale-95 text-sm md:text-base">
                            <Icon name="play" size={18} /> Launch Preview
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {/* New List Card */}
                        <div className="glass p-8 rounded-3xl border-dashed border-2 flex flex-col justify-center gap-4">
                            <h2 className="text-xl font-bold mb-2">Create New List</h2>
                            <div className="flex flex-col gap-3">
                                <input
                                    type="text" value={newListName} onChange={e => setNewListName(e.target.value)}
                                    placeholder="List title..." className="bg-transparent border-b-2 border-white/10 p-3 outline-none focus:border-blue-500 transition-all font-semibold"
                                />
                                <button onClick={addList} className="bg-blue-600 p-4 rounded-2xl font-bold flex gap-2 items-center justify-center hover:bg-blue-500 transition-all">
                                    <Icon name="plus" size={20} /> Add List
                                </button>
                                <div className="relative flex items-center py-2">
                                    <div className="flex-grow border-t border-white/5"></div>
                                    <span className="flex-shrink mx-4 text-[10px] font-black text-white/20 uppercase tracking-widest">or</span>
                                    <div className="flex-grow border-t border-white/5"></div>
                                </div>
                                <button onClick={() => { setImportTargetListId(null); setShowImport(true); }} className="p-4 rounded-2xl border border-white/10 font-bold flex gap-2 items-center justify-center hover:bg-white/5 transition-all text-sm uppercase tracking-wider">
                                    <Icon name="file-text" size={18} /> Bulk Import
                                </button>
                            </div>
                        </div>

                        {state.lists.map(list => (
                            <div key={list.id} className="glass p-8 rounded-3xl flex flex-col gap-6 relative group overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-all" />
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold tracking-tight">{list.name}</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setImportTargetListId(list.id); setShowImport(true); }} className="text-white/20 hover:text-blue-400 transition-all" title="Import to this list">
                                            <Icon name="upload" size={18} />
                                        </button>
                                        <button onClick={() => deleteList(list.id)} className="text-white/20 hover:text-red-500 transition-all">
                                            <Icon name="trash-2" size={18} />
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                    {list.items.map((item, idx) => {
                                        const isActive = state.activeItemId === item.id && state.activeListId === list.id;
                                        return (
                                            <div key={item.id} className={`p-4 rounded-2xl border transition-all ${isActive ? 'bg-blue-600/20 border-blue-500' : 'bg-white/5 border-white/10'}`}>
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-[10px] font-bold text-white/30 uppercase">Index {idx + 1}</span>
                                                    <input
                                                        className="bg-transparent font-bold outline-none flex-1 truncate"
                                                        value={item.name}
                                                        onChange={e => updateItem(list.id, item.id, { name: e.target.value })}
                                                    />
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        className="bg-transparent text-xs text-white/40 outline-none flex-1 truncate"
                                                        value={item.link}
                                                        onChange={e => updateItem(list.id, item.id, { link: e.target.value })}
                                                    />
                                                    <button
                                                        onClick={() => selectItem(list.id, item.id)}
                                                        className={`px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all ${isActive ? 'bg-blue-500 shadow-lg shadow-blue-500/40' : 'hover:bg-white/10'}`}
                                                    >
                                                        {isActive ? 'Active' : 'Select'}
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <button onClick={() => addItem(list.id)} className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-white/30 hover:text-white hover:border-white/30 transition-all flex items-center justify-center gap-2 font-bold uppercase text-xs">
                                    <Icon name="plus" size={16} /> Add Link
                                </button>
                            </div>
                        ))}
                    </div>

                    {showImport && <BulkImport onImport={handleImport} onClose={() => setShowImport(false)} />}
                </div>
            );
        };

        const BulkImport = ({ onImport, onClose }) => {
            const [text, setText] = useState('');
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setText(event.target.result);
                };
                reader.readAsText(file);
            };

            const runImport = () => {
                const parsed = parseIngestedContent(text);
                if (parsed.length > 0) {
                    onImport(parsed);
                } else {
                    alert("No links found in the text. Format should be 'Name: URL', [Name](URL), or Python tuples.");
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-xl animate-fade-in shadow-2xl">
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.9, y: 20 }}
                        className="glass w-full max-w-2xl p-8 rounded-[2.5rem] flex flex-col gap-6 shadow-2xl relative border-white/20"
                    >
                        <button onClick={onClose} className="absolute top-6 right-6 text-white/40 hover:text-white transition-all bg-white/10 p-2 rounded-full">
                            <Icon name="x" size={20} />
                        </button>

                        <div>
                            <h2 className="text-3xl font-black tracking-tighter bg-gradient-to-r from-blue-400 to-purple-600 bg-clip-text text-transparent">BULK INGEST</h2>
                            <p className="text-white/40 text-sm mt-1 font-medium">Inject text, code, or files generated by an LLM.</p>
                        </div>

                        <div className="relative">
                            <textarea
                                className="bg-black/40 border border-white/10 rounded-2xl p-6 h-80 text-xs font-mono focus:border-blue-500 outline-none w-full custom-scrollbar resize-none placeholder:text-white/10"
                                placeholder={"Paste here. We support many formats:\n\n1. Markdown: [Google](https://google.com)\n2. Python: ('Google', 'https://google.com')\n3. Plain text: Google - https://google.com\n4. JSON: {\"name\": \"Google\", \"link\": \"...\"}"}
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                            />
                            <div className="absolute bottom-4 right-4 flex gap-2">
                                <button
                                    onClick={() => setText('')}
                                    className="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-[10px] font-bold uppercase tracking-widest text-white/30 transition-all"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>

                        <div className="flex gap-4">
                            <button
                                onClick={() => fileInputRef.current.click()}
                                className="flex-1 py-4 rounded-2xl border border-white/10 text-white/60 hover:text-white hover:bg-white/5 transition-all flex items-center justify-center gap-2 font-bold text-xs uppercase tracking-widest"
                            >
                                <Icon name="file-text" size={16} /> Upload
                            </button>
                            <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} />

                            <button
                                onClick={runImport}
                                className="flex-[2] py-4 rounded-2xl bg-blue-600 hover:bg-blue-500 transition-all font-bold flex items-center justify-center gap-3 text-xs uppercase tracking-[0.2em] shadow-lg shadow-blue-500/20"
                            >
                                <Icon name="zap" size={18} /> Inject Now
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const QRView = ({ activeLink, setView }) => {
            const canvasRef = useRef(null);
            const isLocalhost = window.location.hostname === 'localhost';
            const redirectUrl = useMemo(() => {
                const base = window.location.href.split('?')[0];
                const normalizedBase = base.endsWith('/') ? base.slice(0, -1) : base;
                return normalizedBase + '/r';
            }, []);

            useEffect(() => {
                if (window.QRious && canvasRef.current) {
                    new QRious({
                        element: canvasRef.current,
                        value: redirectUrl,
                        size: 320,
                        level: 'H',
                        foreground: '#000000',
                        background: '#ffffff'
                    });
                }
            }, [redirectUrl]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-8 bg-[#050505]">
                    <button onClick={() => setView('dashboard')} className="absolute top-12 left-12 flex items-center gap-2 text-white/30 hover:text-white transition-all uppercase tracking-widest text-xs font-bold">
                        <Icon name="arrow-left" size={18} /> Back
                    </button>

                    <div className="glass p-12 rounded-[3rem] flex flex-col items-center gap-8 shadow-2xl border-white/5">
                        <div className="p-6 bg-white rounded-[2.5rem] shadow-2xl">
                            <canvas ref={canvasRef} width="320" height="320" className="max-w-full h-auto"></canvas>
                        </div>

                        <div className="text-center">
                            <h2 className="text-3xl font-black mb-4 tracking-tighter">DYNAMIC REDIRECT</h2>
                            <p className="text-white/30 max-w-sm mb-8 font-medium">This QR never changes. Its target is updated instantly from your control panel or lock screen.</p>

                            <div className="flex flex-col items-center gap-3">
                                <span className="text-[10px] font-black uppercase tracking-[0.2em] text-blue-400">Current Target</span>
                                <div className="glass px-6 py-3 rounded-full flex items-center gap-4 border-white/10">
                                    <span className="text-sm font-mono truncate max-w-[200px]">{activeLink}</span>
                                    <Icon name="refresh-cw" size={14} className="animate-spin-slow text-blue-500" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LockScreen = ({ state, updateState, setView }) => {
            const [pin, setPin] = useState('');
            const [time, setTime] = useState(new Date());
            const [hint, setHint] = useState(false);
            const [feedback, setFeedback] = useState('');

            useEffect(() => {
                const i = setInterval(() => setTime(new Date()), 10000);
                return () => clearInterval(i);
            }, []);

            const activeList = state.lists.find(l => l.id === state.activeListId);

            const handlePin = (n) => { if (pin.length < 8) setPin(p => p + n); };
            const handleClear = () => setPin(p => p.slice(0, -1));

            const handleEmergency = () => {
                const idx = state.lists.findIndex(l => l.id === state.activeListId);
                const next = state.lists[(idx + 1) % state.lists.length];
                updateState({ activeListId: next.id });
                setHint(true);
                setTimeout(() => setHint(false), 1500);
            };

            const handleOk = () => {
                if (!pin) return;

                // Use the number exactly as entered (1-based index)
                const targetIdx = parseInt(pin) - 1;

                if (activeList && activeList.items[targetIdx]) {
                    const item = activeList.items[targetIdx];
                    updateState({ activeItemId: item.id });
                    setFeedback(item.name);
                    setPin('');
                } else {
                    setFeedback('ERR');
                }
                setTimeout(() => setFeedback(''), 1200);
            };

            return (
                <div className="fixed inset-0 bg-[#0c1a21] z-50 flex flex-col items-center justify-between py-12 select-none overflow-hidden font-sans">
                    <div className="z-10 text-center mt-6">
                        <h1 className="text-[80px] font-extralight text-white/90 leading-none mb-2">
                            {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                        </h1>
                        <p className="text-xl text-white/70 font-normal lowercase">
                            {time.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'long' })}
                        </p>
                    </div>

                    <div className="z-10 w-full max-w-[340px] px-8 flex-1 flex flex-col justify-center">
                        <div className="flex flex-col items-center mb-10">
                            <div className="flex gap-4 mb-8 flex-wrap justify-center max-w-[280px]">
                                {[...Array(Math.max(4, pin.length))].map((_, i) => (
                                    <div key={i} className={`w-[10px] h-[10px] rounded-full border border-white/40 transition-all duration-150 ${i < pin.length ? 'bg-white scale-110 shadow-[0_0_8px_rgba(255,255,255,0.5)]' : 'bg-transparent opacity-30'}`} />
                                ))}
                            </div>
                            <div className="h-4 flex items-center">
                                <AnimatePresence mode="wait">
                                    {feedback ? (
                                        <motion.div
                                            key="fb" initial={{ opacity: 0 }} animate={{ opacity: 0.15 }} exit={{ opacity: 0 }}
                                            className="text-[9px] text-white font-bold uppercase tracking-[0.4em]"
                                        >
                                            {feedback}
                                        </motion.div>
                                    ) : (
                                        <motion.div
                                            key="ins" initial={{ opacity: 0 }} animate={{ opacity: 0.6 }} exit={{ opacity: 0 }}
                                            className="text-[11px] text-white font-medium tracking-[0.2em] uppercase"
                                        >
                                            Inserisci il PIN
                                        </motion.div>
                                    )}
                                </AnimatePresence>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-y-5 gap-x-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                <button key={n} onClick={() => handlePin(n)} className="w-[75px] h-[75px] rounded-full bg-white/[0.08] flex items-center justify-center text-[32px] font-normal text-white/90 active:bg-white/20 transition-colors mx-auto">{n}</button>
                            ))}

                            <button onClick={handleEmergency} className="w-full flex items-center justify-center text-[11px] font-bold text-white/80 uppercase tracking-widest active:opacity-50 transition-opacity">
                                EMERGENZA
                            </button>

                            <button onClick={() => handlePin(0)} className="w-[75px] h-[75px] rounded-full bg-white/[0.08] flex items-center justify-center text-[32px] font-normal text-white/90 active:bg-white/20 transition-colors mx-auto">0</button>

                            <button onClick={handleClear} onDoubleClick={() => setView('dashboard')} className="w-full h-full flex items-center justify-center text-white/70 active:opacity-50 transition-opacity">
                                <Icon name="delete" size={28} />
                            </button>
                        </div>

                        {/* Large Invisible OK Trigger */}
                        <div className="mt-4 flex justify-center h-20">
                            <button
                                onClick={handleOk}
                                className="w-full h-full bg-transparent outline-none border-none cursor-default active:bg-white/[0.01]"
                                aria-label="Confirm"
                            />
                        </div>
                    </div>

                    <div className="z-10 w-full flex flex-col items-center pb-4">
                        <AnimatePresence>
                            {hint && (
                                <motion.div
                                    initial={{ opacity: 0 }} animate={{ opacity: 0.12 }} exit={{ opacity: 0 }}
                                    className="text-[9px] text-white font-bold tracking-[0.4em] uppercase"
                                >
                                    {activeList?.name}
                                </motion.div>
                            )}
                        </AnimatePresence>

                    </div>
                </div>
            );
        };

        const RedirectView = ({ activeLink }) => {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center gap-8 bg-black font-mono">
                    <div className="relative">
                        <div className="w-16 h-16 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin" />
                        <div className="absolute inset-0 flex items-center justify-center">
                            <i data-lucide="external-link" className="w-6 h-6 text-blue-500/40"></i>
                        </div>
                    </div>
                    <div className="text-center space-y-2">
                        <p className="text-blue-500/60 text-xs font-black uppercase tracking-[0.4em]">Redirecting</p>
                        <p className="text-white/20 text-[10px] truncate max-w-[250px]">{activeLink}</p>
                    </div>
                </div>
            );
        };

        const GoogleMode = ({ settings, setView, updateTarget }) => {
            const [inputValue, setInputValue] = useState('');
            const [secretQuery, setSecretQuery] = useState('');
            const fakePhrase = settings.fakePhrase || "Quante canzoni ci sono nel mondo?";

            const handleKeyDown = async (e) => {
                // Prevent default scrolling/tabbing but allow natural keyboard flow
                if (e.key === 'Tab') e.preventDefault();

                if (e.key === 'Enter') {
                    let targetUrl = '';
                    const actualQuery = secretQuery || "Vasco Rossi"; // Fallback for testing if empty
                    const q = encodeURIComponent(actualQuery);

                    switch (settings.targetService) {
                        case 'youtube': targetUrl = `https://www.youtube.com/results?search_query=${q}`; break;
                        case 'google_images': targetUrl = `https://www.google.it/search?q=${q}&tbm=isch`; break;
                        case 'spotify': targetUrl = `https://open.spotify.com/search/${q}`; break;
                        default: targetUrl = `https://www.google.it/search?q=${q}`;
                    }

                    // Await the target update to ensure server receives it before navigation
                    try {
                        console.log("Setting secret target to:", targetUrl);
                        await updateTarget(targetUrl);
                    } catch (err) {
                        console.error("Failed to sync secret target:", err);
                    }

                    // Now redirect the local browser to the fake search results
                    window.location.href = `https://www.google.it/search?q=${encodeURIComponent(fakePhrase)}`;
                    return;
                }

                if (e.key === 'Backspace') {
                    setSecretQuery(prev => prev.slice(0, -1));
                    setInputValue(prev => prev.slice(0, -1));
                    return;
                }

                if (e.key.length === 1) {
                    setSecretQuery(prev => prev + e.key);
                    setInputValue(prev => {
                        if (prev.length < fakePhrase.length) {
                            return fakePhrase.slice(0, prev.length + 1);
                        }
                        return prev + fakePhrase.slice(-1);
                    });
                }

                if (e.key === 'Escape') {
                    updateState({ isStealth: false });
                    setView('dashboard');
                }
            };

            const trending = [
                "la preside anticipazioni quarta puntata",
                "matteo zuppi referendum",
                "asta btp",
                "giochi ps plus febbraio 2026",
                "neve previsioni",
                "virus nipah india",
                "materie esame maturitÃ "
            ];

            return (
                <div className="fixed inset-0 bg-[#202124] z-[60] flex flex-col text-[#e8eaed] font-sans google-font cursor-default overflow-y-auto overflow-x-hidden">
                    {/* Header Tabs */}
                    <div className="flex justify-between items-center px-4 pt-3 pb-1 shrink-0">
                        <div className="flex gap-6 text-[11px] font-bold tracking-wider text-[#bdc1c6] items-center h-10 border-b-2 border-transparent">
                            <div className="relative h-full flex items-center text-[#8ab4f8] border-b-2 border-[#8ab4f8] px-1 translate-y-[2px]">TUTTI</div>
                            <div className="px-1 translate-y-[2px]">IMMAGINI</div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="grid grid-cols-3 gap-1 shrink-0">
                                {[...Array(9)].map((_, i) => <div key={i} className="w-1 h-1 bg-[#bdc1c6] rounded-full" />)}
                            </div>
                            <div className="w-8 h-8 rounded-full bg-[#f06292] text-white flex items-center justify-center font-medium text-sm border-2 border-[#202124] shadow-sm">D</div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center pt-8 md:pt-12 px-4 md:px-6 w-full max-w-full">
                        {/* Logo */}
                        <div className="mb-6 mt-4" onDoubleClick={() => { updateState({ isStealth: false }); setView('dashboard'); }}>
                            <div className="w-[160px] md:w-[240px] h-auto pointer-events-none select-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 272 92" className="w-full h-auto">
                                    <path fill="#ffffff" d="M115.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18C71.25 34.32 81.24 25 93.5 25s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44S80.99 39.2 80.99 47.18c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z" />
                                    <path fill="#ffffff" d="M163.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18c0-12.85 9.99-22.18 22.25-22.18s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44s-12.51 5.46-12.51 13.44c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z" />
                                    <path fill="#ffffff" d="M209.75 26.34v39.82c0 16.38-9.66 23.07-21.08 23.07-10.75 0-17.22-7.19-19.66-13.07l8.48-3.53c1.51 3.61 5.21 7.87 11.17 7.87 7.31 0 11.84-4.51 11.84-13v-3.19h-.34c-2.18 2.69-6.38 5.04-11.68 5.04-11.09 0-21.25-9.66-21.25-22.09 0-12.52 10.16-22.26 21.25-22.26 5.29 0 9.49 2.35 11.68 4.96h.34v-3.61h9.25zm-8.56 20.92c0-7.81-5.21-13.52-11.84-13.52-6.72 0-12.35 5.71-12.35 13.52 0 7.73 5.63 13.36 12.35 13.36 6.63 0 11.84-5.63 11.84-13.36z" />
                                    <path fill="#ffffff" d="M225 3v65h-9.5V3h9.5z" />
                                    <path fill="#ffffff" d="m262.02 54.48 7.56 5.04c-2.44 3.61-8.32 9.83-18.48 9.83-12.6 0-22.01-9.74-22.01-22.18 0-13.19 9.49-22.18 20.92-22.18 11.51 0 17.14 9.16 18.98 14.11l1.01 2.52-29.65 12.28c2.27 4.45 5.8 6.72 10.75 6.72 4.96 0 8.4-2.44 10.92-6.14zm-23.27-7.98 19.82-8.23c-1.09-2.77-4.37-4.7-8.23-4.7-4.95 0-11.84 4.37-11.59 12.93z" />
                                    <path fill="#ffffff" d="M35.29 41.41V32H67c.31 1.64.47 3.58.47 5.68 0 7.06-1.93 15.79-8.15 22.01-6.05 6.3-13.78 9.66-24.02 9.66C16.32 69.35.36 53.89.36 34.91.36 15.93 16.32.47 35.3.47c10.5 0 17.98 4.12 23.6 9.49l-6.64 6.64c-4.03-3.78-9.49-6.72-16.97-6.72-13.86 0-24.7 11.17-24.7 25.03 0 13.86 10.84 25.03 24.7 25.03 8.99 0 14.11-3.61 17.39-6.89 2.66-2.66 4.41-6.46 5.1-11.65l-22.49.01z" />
                                </svg>
                            </div>
                        </div>

                        {/* Search Bar - Precise Mobile Style */}
                        <div className="w-full max-w-[584px] px-2 md:px-0">
                            <div className="flex items-center w-full px-4 h-[46px] bg-[#303134] rounded-full shadow-md border border-transparent transition-all">
                                <Icon name="search" size={18} className="text-[#9aa0a6] mr-4 shrink-0" />
                                <input
                                    autoFocus
                                    className="flex-1 bg-transparent text-base outline-none text-[#e8eaed] placeholder-transparent"
                                    value={inputValue}
                                    onKeyDown={handleKeyDown}
                                    onChange={() => { }}
                                />
                            </div>
                        </div>

                        {/* Trending Section */}
                        <div className="w-full max-w-[584px] mt-8 text-[#e8eaed] px-2 md:px-0">
                            <div className="flex justify-between items-center mb-4 px-2">
                                <span className="text-xl font-normal">Ricerche di tendenza</span>
                                <Icon name="more-vertical" size={20} className="text-[#9aa0a6]" />
                            </div>
                            <div className="space-y-0">
                                {trending.map((item, idx) => (
                                    <div key={idx} className="flex items-center justify-between py-4 border-b border-[#3c4043]">
                                        <div className="flex items-center gap-4 truncate">
                                            <Icon name="trending-up" size={20} className="text-[#9aa0a6] shrink-0" />
                                            <span className="text-base truncate font-normal leading-tight">{item}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="bg-[#171717] mt-8 shrink-0">
                        <div className="px-6 py-4 border-b border-[#3c4043] text-sm text-[#9aa0a6]">Italia</div>
                        <div className="px-6 py-4 flex flex-wrap gap-x-6 gap-y-4 text-xs text-[#9aa0a6] justify-center md:justify-start">
                            <span>Tema scuro: on</span>
                            <span>Impostazioni</span>
                            <span>Privacy</span>
                            <span>Termini</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        const isRedirect = new URLSearchParams(window.location.search).get('r') === '1';

        if (isRedirect) {
            // Render nothing or just a black screen during the micro-second of redirect
            root.render(<div className="bg-black min-h-screen"></div>);
        } else {
            root.render(<App />);
        }
    </script>
</body>

</html>